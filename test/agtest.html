<html>
<head>
<script src="http://bp.yahooapis.com/2.4.20/browserplus.js"></script>
<script>

Config = function()
{
	var me = {};

	me.corelets = [ {service:'SearchDBService', version:null, minversion:'1.0'} ];

	return me;
}();

BPUtils = function()
{
    function output(msg) {
      //alert(msg);
      console.log(msg);
    };

	var me = {};
	
	me.init = function()
	{
		if(!BrowserPlus.isInitialized())
		{
			BrowserPlus.init({}, me.onInit);
		}
	}
	
	me.onInit = function(installed)
	{
		output("BP inited successfully");
		me.initAndLoadCorelets();
	}
	
	me.initAndLoadCorelets = function()
	{
		if(!BrowserPlus.isInitialized())
		{
			me.init();
			return;
		}
		output("Loading corelets");
		for(var corelet in Config.corelets)
		{
			output("Is " + Config.corelets[corelet] + " loaded?");
			if(!BrowserPlus.isServiceLoaded(Config.corelets[corelet].service))
			{
				output("Loading: " + Config.corelets[corelet].service);
				BrowserPlus.require(
					{
						services: [ Config.corelets[corelet] ],
						progressCallback: me.onProgress
					},
					me.onCoreletLoaded
				);
			}
		}
		output("Finished loading");
	}
	
	me.onProgress = function(progress)
	{
		output(progress);
	}
	
	me.onCoreletLoaded = function(result)
	{
		if(result.success)
		{
			output("Success");
			BrowserPlus.SearchDBService.init({}, me.onSearchInit);
		}
		else
		{
			output("Not success: " + result.error + " " + result.verboseError);
		}
	}
	
	me.onSearchInit = function()
	{
		output("onSearchInit");
		BrowserPlus.SearchDBService.openIndex({dbName:"testIndex"}, me.onOpenIndex);
	}
	
	me.onOpenIndex = function()
	{
		output("onOpenIndex");
		BrowserPlus.SearchDBService.addDocument(
			{ subject : "Try V14AGRA!", body: "You don't know what you're missing" },
			me.onAddDocument);
	}
	
	me.onAddDocument = function()
	{
		output("onAddDocument");
		BrowserPlus.SearchDBService.closeIndex({}, me.onCloseIndex);
	}
	
	me.onCloseIndex = function()
	{
		output("onCloseIndex");
		BrowserPlus.SearchDBService.search({query:"what", fields:["body"]}, me.onSearch);
	}
	
	me.onSearch = function(results)
	{
		output("onSearch");
		for(var i in results)
		{
			output(i.body);
		}
		output("DONE!");
	}
	
	return me;
};

(function()
{
	var bpUtils = BPUtils();
	bpUtils.init();
}());



</script>
</head>
<body>
</body>
</html>
